# 转动电机

>   直流电机（direct current machine）是指能将直流电能转换成机械能（直流电动机）或将机械能转换成直流电能（直流发电机）的旋转电机。它是能实现直流电能和机械能互相转换的电机。当它作电动机运行时是直流电动机，将电能转换为机械能；作发电机运行时是直流发电机，将机械能转换为电能。（源自：百度百科）

![img](https://pic3.zhimg.com/v2-a5f6cd1dbe3d5f54019bdc4fe030b5da_b.webp)

新来的小伙伴们，你们好啊，我是集。欢迎你打开入门智能车的第一篇章：转动电机，在这篇文章里，我们将学习如何使用MCU来控制一个直流有刷电机。

## 从电机开始说起

各位小伙伴可能会有一个疑问，为什么我们做智能车要先从驱动电机开始做起呢？大家可能小时候或多或少有接触过玩具四驱车：电池一装、开关一开，四驱车的轮子就呼啸着转动起来，这时我们把四驱车放在地上，它就会飞快向前奔跑。而让轮子转动起来的正是四驱车中安装好的电机，也就是我们常说的马达。

玩具四驱车中用的电机一般是有刷直流电机，和我们在智能车中用的电机是同一种。这种电机价格便宜、驱动原理简单，很适合用在对电机性能要求不高的场合。直流电机的转动原理很简单：通电导体在磁场中受到力的作用，这个力绕着轴旋转，电机就转动了起来。

![img](https://bkimg.cdn.bcebos.com/pic/574e9258d109b3de9c8253d2c7ef7b81800a19d8e673?x-bce-process=image/format,f_auto)

我们可以根据左手定则判断力的作用方向。根据左手定则我们很容易知道，如果通电导体在旋转的过程中电流方向保持不变，则正半周和负半周导体所受的力方向相反。如果导体在正半周加速，到了负半周则会因为受到与速度方向相反的分力而减速，结果导致旋转轴在正负半周来回摆动。为了解决这个问题，我们设计了电刷和换向器，使得流过导体的电流在正负半周交替时能更换方向，避免了正负半周力作用方向不同的问题。而电刷和换向器正是有刷直流电机命名的由来。

![左手定则](https://bkimg.cdn.bcebos.com/pic/c9fcc3cec3fdfc03dadc57a7d73f8794a4c2260c?x-bce-process=image/resize,m_lfit,w_536,limit_1/format,f_jpg)

介绍了这么多有刷直流电机，我们再回到智能车上来，为什么我们要先学习驱动电机呢？答案显而易见：我们的小车是由电机带着向前跑的，想要让小车跑起来，第一步就是让电机转起来。

## 脉冲宽度调制（PWM）

在之前的篇章中我们提到，想要让电机转起来只需要把电池正负极接到电机上就可以了，这种方法很简单，也是玩具四驱车中常见的作法，真正困难的是如何控制电机的转速和方向。接下来就由我来教你们如何使用MCU控制电机转动。

在开始电机转速控制的讲解之前，我们先来看这样一幅图：

![点击查看源网页](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Finews.gtimg.com%2Fnewsapp_match%2F0%2F2831784203%2F0.jpg&refer=http%3A%2F%2Finews.gtimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620561708&t=bb1ef41d1c74b083478c0af15e66afca)

这是一连串照片组合而成的影像，记录的是背着骑手的马奔跑的画面。这样的影像是由一张张**静态的照片**（离散）组合而来的，通过一定的技术手段将事先整理好顺序的照片**快速地**在我们眼前播放，我们看到的画面就仿佛**动起来**（连续）了一样，骑手和马的动作变得连贯了起来。相信很多同学都知道了，这其实就是视频的由来，将静态画面按顺序组合在一起快速播放，画面就会产生动起来的效果，可这和我们控制电机转速有什么关系呢？这里我们就要开始介绍脉冲宽度调制了。

![点击查看源网页](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimages.cnitblog.com%2Fblog%2F41072%2F201412%2F230958290151688.gif&refer=http%3A%2F%2Fimages.cnitblog.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1636778874&t=44652bd0e11081cbeee816438ce88b63)

那什么是脉冲宽度调制呢？脉冲宽度调制的本质其实就是利用面积等效原理来改变波形的有效值。可能有点难理解，我们看上图，这是一个由0V电压和5V电压组成的方波图，并且我们注意到方波有重复的部分，也就是说一段时间内会有多个重复的方波出现（频率）。根据0V和5V在同一个周期所占时间的不同，我们看到右边的电压也会随之发生变化，经过简单计算我们可以得知，当5V在一个周期内所占时间达到20%时，右边的电压值会变成（5*(20/100)=）1V，到这里是不是似乎有点理解脉冲宽度调制了呢？我们再看一个例子：假设一个灯泡只有亮、灭两种状态，如果我们想让灯泡50%亮，我们应该怎么做？我们想到可以让灯泡一半时间亮，一半时间灭，但这样可能看不出50%亮的效果，更多可能看到的是灯在亮灭交替闪烁，但如果我们亮灭的速度再快些，快到产生残影、让肉眼分辨不出亮灭呢？这时我们好像就获得了50%亮的效果。到这里，你应该已经理解了脉冲宽度调制，让我们再回到电机上。

我们控制电机转速其实也是一样的，把电池接在电机上，在电池和电机中间加入个超高速开关。在有了开关之后，我们控制电机就有了两种状态：开关打开，电机通电，开关关上，电机断电。当我们打开开关，电池电压直接加在电机上，当我们断开开关，电机两端的电压就变回零。我们一直开着开关，电池电压占满整个周期，电机会全力转动；我们一直断开开关，电机减速直至停止。如果我们想要让电机有全力转动时10%的转速...你应该已经明白要怎么做了吧。

你应该已经注意到了，不管是电机转速还是灯的亮度，其实都是离散量经过快速变换转换而成的连续量，所以这里我们引入脉冲宽度调制很重要的两个参数：占空比和频率。

-   **占空比**

占空比其实就是开关量中开启所占的时间比例，拿上图中1V的例子来讲，它所使用的PWM波的占空比就是20%。我们调节电机的转速，主要也是通过改变占空比来实现的。

-   **频率**

在讲解脉冲宽度调制时，我们多次提到了快速二字，快到产生残影，快到肉眼无法分辨。频率就是同一个波形在一段时间内重复出现的次数，比如一个灯按周期规律开启和关闭，在一秒内这个灯开启了两次、关闭了两次，那它的频率就是2。

## 让电机转动起来吧

理论基础的部分到这里就讲完了，接下来让我们开始动手实践，让电机转起来吧。

### 工程文件

那么我们从哪里开始呢？现在的你想要写代码，却不知道代码应该写在哪里，所以我们需要先获取工程文件，获得我们写代码的地方。

我们先打开逐飞科技的淘宝店，寻找自己使用的MCU。这里是链接[逐飞科技商品页面](https://seekfree.taobao.com/category-1223962322.htm?spm=a1z10.5-c-s.w4010-22508770844.27.6e38a9356BCfXc&search=y&parentCatId=1223962321&parentCatName=%CF%B5%CD%B3%B0%E5%BC%B0%CF%C2%D4%D8%C6%F7%D7%A8%C7%F8&catName=%D7%EE%D0%A1%CF%B5%CD%B3%B0%E5#bd)。

在这里我使用的是MM32F3277的核心板，所以我点进商品信息页面，将页面拖拽至商品介绍部分。在商品介绍部分，商家会提供跟该款MCU相关的资料介绍，这里我们为了获取工程文件，首先选择进入逐飞的开源库：[逐飞科技开源库](https://gitee.com/seekfree)。我们切换到仓库选项卡下找到MCU对应的开源库点击下载（需要注册登录才可以下载）。下载好的压缩包解压后即可获得我们使用的工程文件。

这里你可能对工程文件的结构比较陌生，我以MM32F3277的工程文件为例，为你简单解析一下文件结构：

-   Seekfree_MM32F3277_Opensource_Library	 #总文件夹
    -   【封装】核心板整体原理图封装+PCB封装	#核心板的封装，硬件关心
    -   【文档】说明书 芯片手册等                            #说明书，*软件的下载也可以在这个文件夹找到
    -   Example                                                            #MCU外设的使用例程，使用外设出问题时可以参考下例程
    -   Seekfree_MM32F3277_Opensource_Library            #开源库，我们经常会用到
        -   Libraries                                                                   #库文件夹，底层代码主要放在这边，重要不可删除
        -   Project                                                                      #项目，用于存放主要工程文件，我们写代码的地方
            -   CODE                                                                 #我们新建的代码文件要存放在这里
            -   IAR                                                                      #IAR的工程文件
            -   MDK                                                                   #Keil的工程文件
            -   USER                                                                  #main.c、isr.c和相关的头文件存放在这里
    -   README.md                                                     #markdown文件，主要用于项目说明

### Keil MDK界面

我主要使用的IDE是Keil MDK，所以在本教程中我主要教你们Keil的使用（如果你还没有安装Keil，则可以通过说明书文件夹中的链接前往下载）。通过点击MDK文件夹中的工程启动文件，我们可以进入到Keil MDK的编辑界面，在这里我们可以编写、调试代码。在开始写代码之前，我们先来了解一下Keil的界面操作。

![MDK界面介绍1](C:\Users\Szasd\Pictures\截图\Ai临时输出\MDK界面介绍1.png)

当我们初次进入工程文件，应该会看到如上的界面，我在图中标出了具有功能的区域，让我们先从这些区域入手了解Keil的基本操作。

1.  **工程文件浏览区**

在这片区域，我们可以浏览当前工程加载的所有文件。我们可以看到已经有一些建立好的文件夹可以被浏览了，我们先来看一下这些文件夹里面存放了哪些代码。

-   MM32F3277

    -   user_c                                                    #存放main和isr

        -   main.c                                            #存放主函数的文件
        -   isr.c                                                 #存放定时器中断函数、外部中断函数和串口中断函数

    -   user_h                                                    #存放isr的头文件

    -   CODE                                                      #用于存放我们编写的代码

    -   seekfree_libraries                                 #逐飞封装好的函数库，用于调用各种MCU外设

    -   seekfree_libraries                                 #逐飞封装好的函数库，用于驱动逐飞提供的外部设备

有一些文件夹因为不常用所以我没有列举出来，你们可以自行探索那些文件的作用。

2.  **文件浏览、函数浏览等切换**

这里我们可以切换左边选项卡的功能，比较常用的两个功能是文件浏览`Project`和函数浏览`Functions`。

3.  **工具栏**

工具栏里面的图标主要提供编译工程、下载代码、新建文件、代码编辑等功能

4.  **调试工具**

在这里我们可以启用调试模式、设置断点，调试功能需要在后面的篇章讲解。

5.  **编译信息输出**

我们在编译工程时，编译信息会输出在下方的选项卡中，在这里你可以查看编译结果，确认自己编写的代码是否能通过编译。

### 编写代码

剩下的中间最大的区域就是我们编写代码的地方了，现在我们在文件浏览区通过文件夹左边的小加号点开user_c文件夹，然后双击main.c文件来查看主函数的构造吧。

![img](file:///C:\Users\Szasd\AppData\Roaming\Tencent\Users\519274834\QQ\WinTemp\RichOle\9_LSN]V@2DR9}3IW~BFF5@F.png)